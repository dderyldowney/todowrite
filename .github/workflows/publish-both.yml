name: Publish Both Packages to PyPI

on:
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to TestPyPI instead of PyPI'
        required: false
        default: false
        type: boolean
      version_bump:
        description: 'Version to bump (major, minor, patch)'
        required: false
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: github.event.inputs.version_bump != ''

    outputs:
      new-version: ${{ steps.version.outputs.new-version }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Bump version
      id: version
      uses: MatthieuSimon/bump-version@v1.5
      with:
        files: |
          lib_package/todowrite/version.py
          cli_package/todowrite_cli/version.py
        version_bump: ${{ github.event.inputs.version_bump }}

    - name: Commit version changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add lib_package/todowrite/version.py cli_package/todowrite_cli/version.py
        git commit -m "Bump version to ${{ steps.version.outputs.new-version }}"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-lib:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run library tests
      run: |
        cd lib_package
        python -m pytest tests/ -v --cov=todowrite --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./lib_package/coverage.xml
        flags: lib_package
        name: lib-package-coverage

  test-cli:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run CLI tests
      run: |
        cd cli_package
        python -m pytest tests/ -v --cov=todowrite_cli --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./cli_package/coverage.xml
        flags: cli_package
        name: cli-package-coverage

  build-lib:
    needs: [test-lib, version-bump]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build hatchling twine pyright

    - name: Build library package
      run: |
        cd lib_package
        python -m build

    - name: Check library package
      run: |
        cd lib_package
        twine check dist/*

    - name: Type check library with pyright
      run: |
        cd lib_package
        pyright todowrite/

    - name: Upload library artifacts
      uses: actions/upload-artifact@v3
      with:
        name: lib-package-dist
        path: lib_package/dist/

  build-cli:
    needs: [test-cli, version-bump]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build hatchling twine pyright

    - name: Build CLI package
      run: |
        cd cli_package
        python -m build

    - name: Check CLI package
      run: |
        cd cli_package
        twine check dist/*

    - name: Type check CLI with pyright
      run: |
        cd cli_package
        pyright todowrite_cli/

    - name: Upload CLI artifacts
      uses: actions/upload-artifact@v3
      with:
        name: cli-package-dist
        path: cli_package/dist/

  publish-lib:
    needs: [test-lib, build-lib]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'false'

    environment:
      name: pypi
      url: https://pypi.org/p/todowrite
      reviewers: ['dderyldowney']

    permissions:
      id-token: write

    steps:
    - name: Download library artifacts
      uses: actions/download-artifact@v3
      with:
        name: lib-package-dist
        path: lib_package/dist/

    - name: Publish library to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}

  publish-cli:
    needs: [test-cli, build-cli, publish-lib]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'false'

    environment:
      name: pypi
      url: https://pypi.org/p/todowrite-cli
      reviewers: ['dderyldowney']

    permissions:
      id-token: write

    steps:
    - name: Download CLI artifacts
      uses: actions/download-artifact@v3
      with:
        name: cli-package-dist
        path: cli_package/dist/

    - name: Publish CLI to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}

  publish-lib-test:
    needs: [test-lib, build-lib]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'true'

    environment:
      name: testpypi
      url: https://test.pypi.org/p/todowrite

    permissions:
      id-token: write

    steps:
    - name: Download library artifacts
      uses: actions/download-artifact@v3
      with:
        name: lib-package-dist
        path: lib_package/dist/

    - name: Publish library to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}

  publish-cli-test:
    needs: [test-cli, build-cli, publish-lib-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'true'

    environment:
      name: testpypi
      url: https://test.pypi.org/p/todowrite-cli

    permissions:
      id-token: write

    steps:
    - name: Download CLI artifacts
      uses: actions/download-artifact@v3
      with:
        name: cli-package-dist
        path: cli_package/dist/

    - name: Publish CLI to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}