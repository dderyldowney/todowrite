# MCP Docker Servers Configuration
# Runs Context7, Filesystem, Git, and other MCP servers as stdio MCP services
# These are stdio-based MCP servers that communicate via stdio, not HTTP
# All paths are relative to the project root where docker-compose is run
# Uses single shared volume with service-specific subdirectories

services:
  # Context7 MCP Server - Documentation and context search (HTTP server on port 3001)
  context7:
    image: mcp/context7:latest
    container_name: mcp-context7
    restart: always
    environment:
      - NODE_ENV=production
      - CONTEXT7_LOG_LEVEL=info
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL:-}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN:-}
      # Database connection (if needed)
      - DATABASE_URL=postgresql://${MCP_DB_USER}:${MCP_DB_PASSWORD}@host.docker.internal:${MCP_DB_PORT}/mcp_tools
    ports:
      - "3001:8080"
    volumes:
      - mcp_shared_data:/app/data
      - ./.claude/context7-config:/app/config:ro
    networks:
      - mcp-network

  # Filesystem MCP Server - Secure file system access (stdio transport)
  filesystem:
    image: mcp/filesystem:latest
    container_name: mcp-filesystem
    restart: always
    environment:
      - NODE_ENV=production
      - FILESYSTEM_ROOT=/workspace
      - FILESYSTEM_ALLOWED_PATHS=/workspace
      # Database connection for tracking
      - DATABASE_URL=postgresql://${MCP_DB_USER}:${MCP_DB_PASSWORD}@host.docker.internal:${MCP_DB_PORT}/${MCP_DB_FILESYSTEM}
    volumes:
      - ..:/workspace:ro
      - mcp_shared_data:/app/data
    networks:
      - mcp-network
    command: ["/workspace"]

  # Git MCP Server - Git repository operations (stdio transport)
  git-server:
    image: mcp/git:latest
    container_name: mcp-git
    restart: always
    environment:
      - NODE_ENV=production
      - GIT_ROOT=/workspace
      - GIT_AUTO_COMMIT=false
      - GIT_LOG_LEVEL=info
      # Database connection for tracking
      - DATABASE_URL=postgresql://${MCP_DB_USER}:${MCP_DB_PASSWORD}@host.docker.internal:${MCP_DB_PORT}/mcp_git
    volumes:
      - ..:/workspace:ro
      - mcp_shared_data:/app/data
      - ${HOME}/.gitconfig:/root/.gitconfig:ro
    networks:
      - mcp-network
    command: ["-r", "/workspace"]

  # GitHub MCP Server - GitHub API integration (stdio transport)
  github-server:
    image: ghcr.io/github/github-mcp-server:latest
    container_name: mcp-github
    restart: always
    environment:
      - NODE_ENV=production
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN}
      - GITHUB_API_URL=${GITHUB_API_URL:-https://api.github.com}
      # Database connection for tracking
      - DATABASE_URL=postgresql://${MCP_DB_USER}:${MCP_DB_PASSWORD}@host.docker.internal:${MCP_DB_PORT}/mcp_github
    volumes:
      - mcp_shared_data:/app/data
    networks:
      - mcp-network
    # stdio MCP servers run as default entrypoint without extra args

  # Playwright MCP Server - Web automation and testing (stdio transport)
  playwright:
    image: mcp/playwright:latest
    container_name: mcp-playwright
    restart: always
    environment:
      - NODE_ENV=production
      - PLAYWRIGHT_HEADLESS=true
      # Database connection for tracking
      - DATABASE_URL=postgresql://${MCP_DB_USER}:${MCP_DB_PASSWORD}@host.docker.internal:${MCP_DB_PORT}/mcp_playwright
    volumes:
      - mcp_shared_data:/app/data
      - ..:/workspace:ro
    networks:
      - mcp-network
    # stdio MCP servers run as default entrypoint without extra args

  # SQLite MCP Server - Database operations (stdio transport)
  sqlite-server:
    image: mcp/sqlite:latest
    container_name: mcp-sqlite
    restart: always
    environment:
      - NODE_ENV=production
      - SQLITE_DB_PATH=/app/data/mcp-sqlite.db
    volumes:
      - mcp_shared_data:/app/data/sqlite
      - mcp_shared_data:/app/cache/sqlite
    networks:
      - mcp-network

  # Python Refactoring MCP Server - Code analysis and refactoring (stdio transport)
  python-refactoring:
    image: mcp/mcp-python-refactoring:latest
    container_name: mcp-python-refactoring
    restart: always
    environment:
      - NODE_ENV=production
      - PYTHON_ROOT=/workspace
      # Database connection for tracking
      - DATABASE_URL=postgresql://${MCP_DB_USER}:${MCP_DB_PASSWORD}@host.docker.internal:${MCP_DB_PORT}/mcp_python_refactoring
    volumes:
      - ..:/workspace:ro
      - mcp_shared_data:/app/data
    networks:
      - mcp-network
    # stdio MCP servers run as default entrypoint without extra args

volumes:
  # Single shared MCP data volume - each service uses its own subdirectory
  mcp_shared_data:
    driver: local

networks:
  mcp-network:
    driver: bridge
    name: mcp-network
    ipam:
      config:
        - subnet: 172.20.0.0/16
