#!/usr/bin/env python3
# type: ignore

import subprocess
from pathlib import Path


def main():
    print("ğŸš€ AFS FastAPI Enhanced Session Context Loader")
    print("===============================================")
    print()

    project_root = Path(__file__).resolve().parent.parent
    summary_file = project_root / "SESSION_SUMMARY.md"

    if not summary_file.is_file():
        print("âš ï¸  SESSION_SUMMARY.md not found.")
        print("   Run './bin/savesession' to create it.")
        return

    # Enhanced: Initialize session monitoring
    print("ğŸ“Š Initializing Session Monitoring...")
    try:
        subprocess.run(
            ["./bin/session-monitor", "start"], cwd=project_root, check=True, capture_output=True
        )
        print("âœ… Session monitoring initialized")
    except subprocess.CalledProcessError:
        print("âš ï¸  Session monitoring initialization failed (continuing)")
    print()

    # Enhanced: Check for pause structure compliance
    print("ğŸ“‹ Validating Pause Structure Compliance...")
    pause_spec_file = project_root / "PAUSE_STRUCTURE_SPECIFICATION.md"
    if pause_spec_file.exists():
        print("âœ… Pause structure specification found")
        print("âœ… Mandatory pause structure will be enforced")
    else:
        print("âš ï¸  Pause structure specification missing")
    print()

    print("ğŸ“‹ Loading Project Context from SESSION_SUMMARY.md...")
    print()

    with open(summary_file) as f:
        summary_content = f.read()

    print(summary_content)

    print()
    print("ğŸ‰ Session Context Successfully Restored!")
    print()

    # Enhanced: Session monitoring status check
    print("ğŸ“Š Current Session Status:")
    try:
        result = subprocess.run(
            ["./bin/session-monitor", "status"], cwd=project_root, capture_output=True, text=True
        )
        if result.returncode == 0:
            # Extract key status lines
            for line in result.stdout.split("\n"):
                if any(keyword in line for keyword in ["Duration:", "State:", "Action:"]):
                    print(f"   {line.strip()}")
        else:
            print("   Session monitoring unavailable")
    except Exception:
        print("   Session monitoring error")
    print()

    # Enhanced: Git status and quality reminder
    print("ğŸ“‹ Current Git Status:")
    try:
        git_result = subprocess.run(
            ["git", "status", "--porcelain"], cwd=project_root, capture_output=True, text=True
        )
        if git_result.stdout.strip():
            print("   âš ï¸  Uncommitted changes detected")
            print("   ğŸ“ Remember: Quality gates must pass before pausing")
        else:
            print("   âœ… Working tree clean")
    except Exception:
        print("   âŒ Git status check failed")
    print()

    print("ğŸ’¾ Enhanced Session Management Commands:")
    print("   â€¢ ./bin/savesession - Save session state before ending")
    print("   â€¢ ./bin/loadsession - Restore session context")
    print()
    print("â¸ï¸  Mandatory Pause Structure Commands:")
    print('   â€¢ ./bin/quality-check-and-pause "[reason]" "[next]" - Quality-validated pause')
    print('   â€¢ ./bin/emergency-pause "[reason]" - Emergency pause (bypasses quality gates)')
    print('   â€¢ ./bin/strategic-milestone-pause "[goal]" "complete" - Strategic milestone')
    print("   â€¢ ./bin/session-monitor check - Check session duration and warnings")
    print()
    print("ğŸ”§ Development Workflow Reminders:")
    print("   â€¢ Follow TDD: RED â†’ GREEN â†’ REFACTOR â†’ Quality Check â†’ Commit")
    print("   â€¢ Pause every 2-3 completed tasks or at 2.5-hour session mark")
    print("   â€¢ All pauses must pass quality gates (unless emergency)")
    print("   â€¢ Use TodoWrite tool to track progress within sessions")
    print()

    print("âœ¨ AFS FastAPI Enterprise Platform Ready with Mandatory Pause Structure")
    print("ğŸš¨ CRITICAL: Follow pause structure compliance - see PAUSE_STRUCTURE_SPECIFICATION.md")


if __name__ == "__main__":
    main()
