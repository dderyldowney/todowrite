# API Reference

This document provides a comprehensive API reference for the `todowrite.app` module, detailing its classes, data structures, and methods.

## Data Structures

### `LayerType`

A literal type defining the 12 hierarchical layers in the ToDoWrite system.

**Possible values:**
*   `"Goal"`
*   `"Concept"`
*   `"Context"`
*   `"Constraints"`
*   `"Requirements"`
*   `"Acceptance Criteria"`
*   `"Interface Contract"`
*   `"Phase"`
*   `"Step"`
*   `"Task"`
*   `"SubTask"`
*   `"Command"`

### `StatusType`

A literal type defining the possible status values for a ToDoWrite node.

**Possible values:**
*   `"planned"`
*   `"in_progress"`
*   `"blocked"`
*   `"done"`
*   `"rejected"`

### `Link` (dataclass)

Represents the parent-child relationships between ToDoWrite nodes.

**Attributes:**

*   `parents`: `list[str]` - A list of IDs of parent nodes. Defaults to an empty list.
*   `children`: `list[str]` - A list of IDs of child nodes. Defaults to an empty list.

### `Metadata` (dataclass)

Represents additional metadata associated with a ToDoWrite node.

**Attributes:**

*   `owner`: `str` - The person or entity responsible for the node.
*   `labels`: `list[str]` - A list of labels or tags for categorization. Defaults to an empty list.
*   `severity`: `str` - The importance or priority level of the node. Defaults to an empty string.
*   `work_type`: `str` - The type of work associated with the node. Defaults to an empty string.

### `Command` (dataclass)

Represents an executable command associated with a ToDoWrite node.

**Attributes:**

*   `ac_ref`: `str` - A reference to the acceptance criteria related to this command.
*   `run`: `dict[str, Any]` - A dictionary containing execution parameters for the command.
*   `artifacts`: `list[str]` - A list of file paths or identifiers for artifacts generated by the command. Defaults to an empty list.

### `Node` (dataclass)

The fundamental data structure representing a single item in the ToDoWrite system.

**Attributes:**

*   `id`: `str` - A unique identifier for the node.
*   `layer`: `LayerType` - The hierarchical layer of the node.
*   `title`: `str` - A concise title for the node.
*   `description`: `str` - A detailed description of the node.
*   `links`: `Link` - An object defining parent and child relationships.
*   `metadata`: `Metadata` - An object containing additional metadata.
*   `status`: `StatusType` - The current status of the node. Defaults to `"planned"`.
*   `command`: `Command | None` - An optional command associated with the node. Defaults to `None`.

## `ToDoWrite` Class

`class ToDoWrite(db_url: str | None = None)`

The main application class that provides an interface for interacting with the ToDoWrite system and its underlying database.

**Constructor:**

*   `__init__(self, db_url: str | None = None)`
    *   Initializes the `ToDoWrite` application instance.
    *   **Parameters:**
        *   `db_url`: `str | None` - An optional SQLAlchemy database URL. If `None`, it defaults to the `DATABASE_URL` from `todowrite.db.config`.

### Methods

#### `init_database()`

`init_database(self) -> None`

Creates all necessary database tables based on the defined models. If using SQLite, it also ensures the directory for the database file exists.

#### `create_node(node_data: dict[str, Any])`

`create_node(self, node_data: dict[str, Any]) -> Node`

Creates a new node in the database.

*   **Parameters:**
    *   `node_data`: `dict[str, Any]` - A dictionary containing the data for the new node. Must include `id`, `layer`, `title`, `description`, `links`, and `metadata`.
*   **Returns:**
    *   `Node` - The newly created `Node` object.

#### `get_node(node_id: str)`

`get_node(self, node_id: str) -> Node | None`

Retrieves a node from the database by its ID.

*   **Parameters:**
    *   `node_id`: `str` - The unique identifier of the node to retrieve.
*   **Returns:**
    *   `Node | None` - The retrieved `Node` object if found, otherwise `None`.

#### `get_all_nodes()`

`get_all_nodes(self) -> dict[str, list[Node]]`

Retrieves all nodes from the database, organized by their `LayerType`.

*   **Returns:**
    *   `dict[str, list[Node]]` - A dictionary where keys are `LayerType` strings and values are lists of `Node` objects belonging to that layer.

#### `update_node(node_id: str, node_data: dict[str, Any])`

`update_node(self, node_id: str, node_data: dict[str, Any]) -> Node | None`

Updates an existing node in the database with new data.

*   **Parameters:**
    *   `node_id`: `str` - The ID of the node to update.
    *   `node_data`: `dict[str, Any]` - A dictionary containing the updated fields for the node. Only provided fields will be updated.
*   **Returns:**
    *   `Node | None` - The updated `Node` object if found and updated, otherwise `None`.

#### `delete_node(node_id: str)`

`delete_node(self, node_id: str) -> None`

Deletes a node from the database. This operation also attempts to clean up related links, labels, commands, and artifacts.

*   **Parameters:**
    *   `node_id`: `str` - The ID of the node to delete.

#### `add_goal(title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_goal(self, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Goal" node to the system. This is a convenience wrapper for `create_node`.

*   **Parameters:**
    *   `title`: `str` - The title of the goal.
    *   `description`: `str` - A detailed description of the goal.
    *   `owner`: `str` - The owner of the goal. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Goal node.

#### `add_phase(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_phase(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Phase" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Goal).
    *   `title`: `str` - The title of the phase.
    *   `description`: `str` - A detailed description of the phase.
    *   `owner`: `str` - The owner of the phase. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Phase node.

#### `add_step(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_step(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Step" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Phase).
    *   `title`: `str` - The title of the step.
    *   `description`: `str` - A detailed description of the step.
    *   `owner`: `str` - The owner of the step. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Step node.

#### `add_task(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_task(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Task" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Step).
    *   `title`: `str` - The title of the task.
    *   `description`: `str` - A detailed description of the task.
    *   `owner`: `str` - The owner of the task. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Task node.

#### `add_subtask(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_subtask(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "SubTask" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Task).
    *   `title`: `str` - The title of the subtask.
    *   `description`: `str` - A detailed description of the subtask.
    *   `owner`: `str` - The owner of the subtask. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created SubTask node.

#### `add_command(parent_id: str, title: str, description: str, ac_ref: str, run: dict[str, Any], artifacts: list[str] | None = None, owner: str = "system", labels: list[str] | None = None)`

`add_command(self, parent_id: str, title: str, description: str, ac_ref: str, run: dict[str, Any], artifacts: list[str] | None = None, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Command" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a SubTask).
    *   `title`: `str` - The title of the command.
    *   `description`: `str` - A detailed description of the command.
    *   `ac_ref`: `str` - Reference to the acceptance criteria.
    *   `run`: `dict[str, Any]` - Execution parameters for the command.
    *   `artifacts`: `list[str] | None` - Optional list of artifact identifiers.
    *   `owner`: `str` - The owner of the command. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Command node.

#### `add_concept(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_concept(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Concept" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Goal).
    *   `title`: `str` - The title of the concept.
    *   `description`: `str` - A detailed description of the concept.
    *   `owner`: `str` - The owner of the concept. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Concept node.

#### `add_context(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_context(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Context" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Concept).
    *   `title`: `str` - The title of the context.
    *   `description`: `str` - A detailed description of the context.
    *   `owner`: `str` - The owner of the context. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Context node.

#### `add_constraint(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_constraint(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Constraints" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Context).
    *   `title`: `str` - The title of the constraint.
    *   `description`: `str` - A detailed description of the constraint.
    *   `owner`: `str` - The owner of the constraint. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Constraint node.

#### `add_requirement(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_requirement(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Requirements" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Constraint).
    *   `title`: `str` - The title of the requirement.
    *   `description`: `str` - A detailed description of the requirement.
    *   `owner`: `str` - The owner of the requirement. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Requirement node.

#### `add_acceptance_criteria(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_acceptance_criteria(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Acceptance Criteria" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., a Requirement).
    *   `title`: `str` - The title of the acceptance criteria.
    *   `description`: `str` - A detailed description of the acceptance criteria.
    *   `owner`: `str` - The owner of the acceptance criteria. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Acceptance Criteria node.

#### `add_interface_contract(parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None)`

`add_interface_contract(self, parent_id: str, title: str, description: str, owner: str = "system", labels: list[str] | None = None) -> Node`

Adds a new "Interface Contract" node to the system, linked to a parent node.

*   **Parameters:**
    *   `parent_id`: `str` - The ID of the parent node (e.g., an Acceptance Criteria).
    *   `title`: `str` - The title of the interface contract.
    *   `description`: `str` - A detailed description of the interface contract.
    *   `owner`: `str` - The owner of the interface contract. Defaults to "system".
    *   `labels`: `list[str] | None` - Optional list of labels.
*   **Returns:**
    *   `Node` - The newly created Interface Contract node.

#### `get_node_by_id(node_id: str)`

`get_node_by_id(self, node_id: str) -> Node | None`

Retrieves a node from the database by its ID. This is an alias for `get_node`.

*   **Parameters:**
    *   `node_id`: `str` - The unique identifier of the node to retrieve.
*   **Returns:**
    *   `Node | None` - The retrieved `Node` object if found, otherwise `None`.

#### `load_todos()`

`load_todos(self) -> dict[str, list[Node]]`

Loads all todos from the database, grouped by their layer. This is an alias for `get_all_nodes`.

*   **Returns:**
    *   `dict[str, list[Node]]` - A dictionary where keys are `LayerType` strings and values are lists of `Node` objects.

#### `get_active_items(todos: dict[str, list[Node]])`

`get_active_items(self, todos: dict[str, list[Node]]) -> dict[str, Node]`

Filters a dictionary of nodes to return only items with a status other than "done" or "rejected". Currently returns only one active item per layer.

*   **Parameters:**
    *   `todos`: `dict[str, list[Node]]` - A dictionary of nodes, typically obtained from `load_todos()`.
*   **Returns:**
    *   `dict[str, Node]` - A dictionary where keys are `LayerType` strings and values are a single active `Node` object for that layer.
